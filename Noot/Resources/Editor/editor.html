<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #0d0d1a;
            --surface: #1a1a2e;
            --text-primary: #e0e0e0;
            --text-muted: #888888;
            --cyan: #00ffff;
            --magenta: #ff00ff;
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            min-height: 100vh;
        }

        .ProseMirror {
            outline: none;
            min-height: calc(100vh - 32px);
        }

        .ProseMirror p {
            margin-bottom: 0.5em;
        }

        .ProseMirror h1, .ProseMirror h2, .ProseMirror h3 {
            color: var(--cyan);
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .ProseMirror h1 { font-size: 1.8em; }
        .ProseMirror h2 { font-size: 1.4em; }
        .ProseMirror h3 { font-size: 1.2em; }

        .ProseMirror code {
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: inherit;
            color: var(--magenta);
        }

        .ProseMirror pre {
            background: var(--surface);
            padding: 12px;
            border-radius: 8px;
            margin: 0.5em 0;
            overflow-x: auto;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .ProseMirror pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        .ProseMirror blockquote {
            border-left: 3px solid var(--cyan);
            padding-left: 1em;
            margin: 0.5em 0;
            color: var(--text-muted);
        }

        .ProseMirror ul, .ProseMirror ol {
            padding-left: 1.5em;
            margin: 0.5em 0;
        }

        .ProseMirror li {
            margin: 0.25em 0;
        }

        .ProseMirror ul[data-type="taskList"] {
            list-style: none;
            padding-left: 0;
        }

        .ProseMirror ul[data-type="taskList"] li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .ProseMirror ul[data-type="taskList"] li > label {
            flex-shrink: 0;
            user-select: none;
        }

        .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--cyan);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            margin-top: 3px;
        }

        .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"]:checked {
            background: var(--cyan);
        }

        .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"]:checked::after {
            content: 'âœ“';
            display: block;
            color: var(--background);
            font-size: 12px;
            text-align: center;
            line-height: 12px;
        }

        .ProseMirror ul[data-type="taskList"] li[data-checked="true"] > div {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .ProseMirror hr {
            border: none;
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            margin: 1em 0;
        }

        .ProseMirror a {
            color: var(--cyan);
            text-decoration: none;
        }

        .ProseMirror a:hover {
            text-decoration: underline;
        }

        .ProseMirror img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5em 0;
        }

        .ProseMirror mark {
            background: rgba(255, 0, 255, 0.3);
            color: inherit;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .ProseMirror strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .ProseMirror em {
            color: var(--text-muted);
        }

        /* Placeholder */
        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: var(--text-muted);
            pointer-events: none;
            height: 0;
        }

        /* Selection */
        .ProseMirror ::selection {
            background: rgba(0, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="editor"></div>

    <script type="importmap">
    {
        "imports": {
            "@tiptap/core": "https://esm.sh/@tiptap/core@2.1.13",
            "@tiptap/starter-kit": "https://esm.sh/@tiptap/starter-kit@2.1.13",
            "@tiptap/extension-task-list": "https://esm.sh/@tiptap/extension-task-list@2.1.13",
            "@tiptap/extension-task-item": "https://esm.sh/@tiptap/extension-task-item@2.1.13",
            "@tiptap/extension-image": "https://esm.sh/@tiptap/extension-image@2.1.13",
            "@tiptap/extension-link": "https://esm.sh/@tiptap/extension-link@2.1.13",
            "@tiptap/extension-placeholder": "https://esm.sh/@tiptap/extension-placeholder@2.1.13",
            "@tiptap/extension-highlight": "https://esm.sh/@tiptap/extension-highlight@2.1.13",
            "@tiptap/pm/state": "https://esm.sh/@tiptap/pm@2.1.13/state",
            "@tiptap/pm/view": "https://esm.sh/@tiptap/pm@2.1.13/view",
            "@tiptap/pm/model": "https://esm.sh/@tiptap/pm@2.1.13/model"
        }
    }
    </script>

    <script type="module">
        import { Editor } from '@tiptap/core';
        import StarterKit from '@tiptap/starter-kit';
        import TaskList from '@tiptap/extension-task-list';
        import TaskItem from '@tiptap/extension-task-item';
        import Image from '@tiptap/extension-image';
        import Link from '@tiptap/extension-link';
        import Placeholder from '@tiptap/extension-placeholder';
        import Highlight from '@tiptap/extension-highlight';

        let editor = null;
        let debounceTimer = null;

        function initEditor(initialContent = '') {
            editor = new Editor({
                element: document.querySelector('#editor'),
                extensions: [
                    StarterKit.configure({
                        heading: {
                            levels: [1, 2, 3],
                        },
                    }),
                    TaskList,
                    TaskItem.configure({
                        nested: true,
                    }),
                    Image.configure({
                        inline: true,
                        allowBase64: true,
                    }),
                    Link.configure({
                        openOnClick: false,
                        HTMLAttributes: {
                            rel: 'noopener noreferrer',
                        },
                    }),
                    Placeholder.configure({
                        placeholder: 'Start typing...',
                    }),
                    Highlight,
                ],
                content: initialContent,
                autofocus: true,
                editorProps: {
                    attributes: {
                        spellcheck: 'true',
                    },
                },
                onUpdate: ({ editor }) => {
                    // Debounce updates to Swift
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const html = editor.getHTML();
                        const text = editor.getText();
                        window.webkit?.messageHandlers?.contentChanged?.postMessage({
                            html: html,
                            text: text
                        });
                    }, 300);
                },
            });

            // Handle keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Cmd+S to save
                if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                    e.preventDefault();
                    const html = editor.getHTML();
                    window.webkit?.messageHandlers?.save?.postMessage({ html: html });
                }
            });

            window.editor = editor;
        }

        // API for Swift
        window.EditorAPI = {
            init: (content) => {
                if (editor) {
                    editor.destroy();
                }
                initEditor(content);
            },
            setContent: (content) => {
                if (editor) {
                    editor.commands.setContent(content);
                }
            },
            getContent: () => {
                return editor ? editor.getHTML() : '';
            },
            getText: () => {
                return editor ? editor.getText() : '';
            },
            insertImage: (src) => {
                if (editor) {
                    editor.chain().focus().setImage({ src: src }).run();
                }
            },
            focus: () => {
                if (editor) {
                    editor.commands.focus();
                }
            }
        };

        // Initialize with empty content
        initEditor('');

        // Let Swift know we're ready
        window.webkit?.messageHandlers?.editorReady?.postMessage({});
    </script>
</body>
</html>
